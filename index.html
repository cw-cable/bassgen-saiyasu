<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>ãƒ™ãƒ¼ã‚¹å¼¦ æœ€å®‰å€¤æ¯”è¼ƒ | ä»Šæ—¥ä¸€ç•ªå®‰ã„ãƒ™ãƒ¼ã‚¹å¼¦ãŒ3ç§’ã§ã‚ã‹ã‚‹</title>
<meta name="description" content="ãƒ™ãƒ¼ã‚¹å¼¦ã®æœ€å®‰å€¤ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¯”è¼ƒã€‚D'Addarioã€Ernie Ballã€Elixirãªã©äººæ°—å‹ç•ªã‚’æœ€å®‰ã‚·ãƒ§ãƒƒãƒ—ã¸å³èª˜å°ã€‚">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f; --surface: #13131c; --surface2: #1a1a28;
    --accent: #ff2d55; --accent2: #ff6b35; --gold: #ffd700;
    --text: #f0f0f8; --muted: #888; --green: #00e676; --border: #2a2a40;
  }
  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  body { background:var(--bg); color:var(--text); font-family:'Noto Sans JP',sans-serif; font-size:14px; line-height:1.4; overflow-x:hidden; }

  /* HEADER */
  header { background:linear-gradient(135deg,#0a0a0f,#13131c); border-bottom:2px solid var(--accent); padding:12px 16px; position:sticky; top:0; z-index:100; display:flex; align-items:center; justify-content:space-between; }
  .logo { font-family:'Bebas Neue',sans-serif; font-size:22px; letter-spacing:2px; color:var(--text); line-height:1; }
  .logo span { color:var(--accent); }
  .logo-sub { font-size:9px; letter-spacing:1px; color:var(--muted); font-weight:400; }
  .update-badge { background:var(--accent); color:white; font-size:9px; font-weight:700; padding:3px 8px; border-radius:3px; letter-spacing:.5px; animation:pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.7} }

  /* HERO */
  .hero { background:linear-gradient(180deg,#13131c,#0a0a0f); padding:20px 16px 16px; text-align:center; border-bottom:1px solid var(--border); }
  .hero-headline { font-family:'Bebas Neue',sans-serif; font-size:28px; letter-spacing:2px; line-height:1.1; margin-bottom:6px; }
  .hero-headline em { color:var(--accent); font-style:normal; }
  .hero-sub { font-size:11px; color:var(--muted); }

  /* NAV TABS */
  .nav-tabs { display:flex; gap:6px; padding:12px 16px; overflow-x:auto; scrollbar-width:none; background:var(--surface); border-bottom:1px solid var(--border); position:sticky; top:57px; z-index:90; }
  .nav-tabs::-webkit-scrollbar { display:none; }
  .tab { flex-shrink:0; padding:8px 14px; border-radius:4px; border:1px solid var(--border); background:var(--bg); color:var(--muted); font-size:12px; font-weight:700; cursor:pointer; transition:all .15s; white-space:nowrap; font-family:'Noto Sans JP',sans-serif; }
  .tab.active { background:var(--accent); border-color:var(--accent); color:white; }

  /* SECTION HEADER */
  .section-header { display:flex; align-items:center; gap:8px; padding:14px 16px 8px; }
  .section-title { font-family:'Bebas Neue',sans-serif; font-size:18px; letter-spacing:2px; }
  .section-badge { background:var(--accent); color:white; font-size:9px; font-weight:700; padding:2px 6px; border-radius:2px; }

  /* LOADING / ERROR */
  .loading-wrap { padding:48px 16px; text-align:center; }
  .loading-spinner { width:36px; height:36px; border:3px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin .8s linear infinite; margin:0 auto 16px; }
  @keyframes spin { to{transform:rotate(360deg)} }
  .loading-text { font-size:12px; color:var(--muted); }
  .error-wrap { margin:16px 12px; background:#ff2d5510; border:1px solid #ff2d5540; border-radius:8px; padding:20px 16px; text-align:center; }
  .error-icon { font-size:28px; margin-bottom:8px; }
  .error-text { font-size:12px; color:#ff6b6b; line-height:1.8; }

  /* PRODUCT CARD */
  .products { padding:0 12px 12px; display:flex; flex-direction:column; gap:10px; }
  .product-card { background:var(--surface); border:1px solid var(--border); border-radius:8px; overflow:hidden; position:relative; transition:border-color .2s; animation:slideUp .4s ease both; cursor:pointer; }
  .product-card:hover { border-color:var(--accent); }
  @keyframes slideUp { from{transform:translateY(20px);opacity:0} to{transform:translateY(0);opacity:1} }
  .card-body { display:flex; gap:10px; padding:12px 12px 10px; }
  .product-img { width:72px; height:72px; border-radius:6px; background:var(--surface2); flex-shrink:0; display:flex; align-items:center; justify-content:center; overflow:hidden; border:1px solid var(--border); }
  .product-img svg { width:40px; height:40px; opacity:.5; }
  .product-info { flex:1; min-width:0; }
  .product-brand { font-size:10px; color:var(--muted); letter-spacing:1px; text-transform:uppercase; margin-bottom:1px; }
  .product-name { font-family:'Bebas Neue',sans-serif; font-size:20px; letter-spacing:1px; line-height:1.1; color:var(--text); margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .product-tags { display:flex; gap:4px; flex-wrap:wrap; margin-bottom:6px; }
  .tag { font-size:9px; padding:2px 5px; border-radius:2px; border:1px solid var(--border); color:var(--muted); }
  .tag-nickel { border-color:#4a9eff40; color:#4a9eff; }
  .tag-coated { border-color:#00e67640; color:var(--green); }
  .tag-5str { border-color:#ff6b3540; color:var(--accent2); }
  .price-block { display:flex; align-items:flex-end; gap:6px; }
  .price-label { font-size:9px; color:var(--muted); margin-bottom:2px; }
  .price-main { font-family:'Bebas Neue',sans-serif; font-size:32px; color:var(--accent); line-height:1; }
  .price-diff { font-size:11px; font-weight:700; color:var(--green); background:#00e67610; border:1px solid #00e67630; padding:2px 6px; border-radius:3px; margin-bottom:3px; white-space:nowrap; }

  /* METER */
  .buy-meter { padding:0 12px 12px; }
  .meter-label { font-size:10px; color:var(--muted); margin-bottom:6px; display:flex; justify-content:space-between; }
  .meter-track { height:6px; background:var(--surface2); border-radius:3px; overflow:hidden; margin-bottom:4px; }
  .meter-fill { height:100%; border-radius:3px; transition:width 1s ease; }
  .meter-status { font-size:11px; font-weight:700; }
  .status-good{color:var(--green)} .status-avg{color:var(--gold)} .status-high{color:var(--muted)}

  /* SHOP COMPARE */
  .shop-compare { display:flex; gap:6px; padding:0 12px 12px; }
  .shop-btn { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:8px 6px; border-radius:6px; border:1px solid var(--border); background:var(--surface2); cursor:pointer; transition:all .15s; }
  .shop-btn:active{opacity:.8}
  .shop-name { font-size:9px; color:var(--muted); margin-bottom:2px; font-weight:700; }
  .shop-price { font-family:'Bebas Neue',sans-serif; font-size:16px; line-height:1; }
  .shop-price.cheapest{color:var(--accent)} .shop-price.normal{color:var(--text)}
  .shop-btn.best-shop { border-color:var(--accent); background:#ff2d5510; }

  /* CTA */
  .cta-btn { display:flex; align-items:center; justify-content:center; gap:8px; height:56px; background:linear-gradient(135deg,var(--accent),#ff4d6b); color:white; font-size:15px; font-weight:900; border:none; cursor:pointer; text-decoration:none; font-family:'Noto Sans JP',sans-serif; letter-spacing:.5px; transition:opacity .15s,transform .1s; margin:0 12px 12px; border-radius:6px; width:calc(100% - 24px); position:relative; overflow:hidden; }
  .cta-btn::after { content:''; position:absolute; inset:0; background:linear-gradient(135deg,rgba(255,255,255,.1),transparent 60%); }
  .cta-btn:active { transform:scale(.98); opacity:.9; }

  /* NOTICE */
  .price-notice { background:#ff2d5510; border:1px solid #ff2d5530; border-radius:4px; padding:8px 12px; margin:0 12px 12px; font-size:10px; color:#ff6b6b; display:flex; align-items:center; gap:6px; }

  /* DETAIL MODAL */
  .product-detail { display:none; position:fixed; inset:0; z-index:300; background:var(--bg); overflow-y:auto; }
  .detail-header { background:var(--surface); border-bottom:1px solid var(--border); padding:14px 16px; display:flex; align-items:center; gap:12px; position:sticky; top:0; z-index:10; }
  .back-btn { display:flex; align-items:center; gap:4px; color:var(--muted); font-size:13px; cursor:pointer; padding:4px 8px; border-radius:4px; border:1px solid var(--border); background:var(--bg); font-family:'Noto Sans JP',sans-serif; }
  .detail-title { font-family:'Bebas Neue',sans-serif; font-size:18px; letter-spacing:1px; }
  .detail-hero { background:var(--surface); padding:24px 16px; text-align:center; border-bottom:1px solid var(--border); }
  .detail-img { width:100px; height:100px; background:var(--surface2); border-radius:10px; margin:0 auto 16px; display:flex; align-items:center; justify-content:center; border:1px solid var(--border); }
  .detail-brand { font-size:11px; color:var(--muted); letter-spacing:2px; text-transform:uppercase; margin-bottom:4px; }
  .detail-name { font-family:'Bebas Neue',sans-serif; font-size:32px; letter-spacing:2px; margin-bottom:12px; }
  .detail-price-label { font-size:11px; color:var(--muted); margin-bottom:4px; }
  .detail-price { font-family:'Bebas Neue',sans-serif; font-size:52px; color:var(--accent); line-height:1; margin-bottom:8px; }
  .detail-diff { display:inline-flex; align-items:center; gap:4px; background:#00e67615; border:1px solid #00e67640; color:var(--green); font-size:13px; font-weight:700; padding:4px 10px; border-radius:4px; }
  .detail-section { padding:16px; border-bottom:1px solid var(--border); }
  .detail-section-title { font-family:'Bebas Neue',sans-serif; font-size:16px; letter-spacing:2px; color:var(--muted); margin-bottom:12px; }
  .shop-list { display:flex; flex-direction:column; gap:8px; }
  .shop-row { display:flex; align-items:center; justify-content:space-between; padding:12px; background:var(--surface); border-radius:6px; border:1px solid var(--border); text-decoration:none; cursor:pointer; transition:border-color .15s; }
  .shop-row.cheapest-row { border-color:var(--accent); background:#ff2d5508; }
  .shop-row-left { display:flex; align-items:center; gap:10px; }
  .shop-icon { width:32px; height:32px; border-radius:6px; display:flex; align-items:center; justify-content:center; font-size:16px; }
  .shop-icon-amazon{background:#ff9900} .shop-icon-rakuten{background:#bf0000} .shop-icon-sh{background:#1a4c9a}
  .shop-row-name { font-size:13px; font-weight:700; }
  .shop-row-note { font-size:10px; color:var(--muted); }
  .shop-row-price { font-family:'Bebas Neue',sans-serif; font-size:22px; }
  .shop-row-price.cheapest{color:var(--accent)}
  .ph-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:6px; }
  .ph-item { background:var(--surface2); border-radius:6px; padding:8px; text-align:center; border:1px solid var(--border); }
  .ph-item-label { font-size:9px; color:var(--muted); margin-bottom:4px; }
  .ph-item-price { font-family:'Bebas Neue',sans-serif; font-size:18px; line-height:1; }
  .ph-item-price.lowest{color:var(--green)} .ph-item-price.current{color:var(--accent)} .ph-item-price.avg{color:var(--text)}
  .judge-card { background:var(--surface2); border-radius:8px; padding:16px; border:1px solid var(--border); text-align:center; }
  .judge-icon { font-size:40px; margin-bottom:8px; }
  .judge-label { font-family:'Bebas Neue',sans-serif; font-size:28px; letter-spacing:2px; margin-bottom:6px; }
  .judge-desc { font-size:12px; color:var(--muted); line-height:1.6; }
  .judge-good .judge-label{color:var(--green)} .judge-avg .judge-label{color:var(--gold)} .judge-high .judge-label{color:var(--muted)}

  /* BOTTOM */
  .bottom-info { padding:16px; font-size:10px; color:var(--muted); line-height:1.8; text-align:center; border-top:1px solid var(--border); }
</style>
</head>
<body>

<header>
  <div>
    <div class="logo">BASS<span>æœ€å®‰</span>.COM</div>
    <div class="logo-sub">ãƒ™ãƒ¼ã‚¹å¼¦ æœ€å®‰å€¤æ¯”è¼ƒ</div>
  </div>
  <div class="update-badge" id="updateBadge">ğŸ”´ èª­ã¿è¾¼ã¿ä¸­...</div>
</header>

<div class="hero">
  <div class="hero-headline">ä»Šæ—¥ä¸€ç•ªå®‰ã„<br><em>ãƒ™ãƒ¼ã‚¹å¼¦</em>ãŒ3ç§’ã§ã‚ã‹ã‚‹</div>
  <div class="hero-sub">Amazonãƒ»æ¥½å¤©ãƒ»ã‚µã‚¦ãƒ³ãƒ‰ãƒã‚¦ã‚¹ã‚’æ¯æ—¥æ¯”è¼ƒ</div>
</div>

<div class="nav-tabs">
  <div class="tab active" onclick="filterProducts('4str',this)">4å¼¦</div>
  <div class="tab" onclick="filterProducts('5str',this)">5å¼¦</div>
</div>

<div class="section-header">
  <span class="section-title">ğŸ¸ ãƒ™ãƒ¼ã‚¹å¼¦ ä¾¡æ ¼æ¯”è¼ƒ</span>
  <span class="section-badge" id="updatedAt">æ›´æ–°ä¸­</span>
</div>

<div class="price-notice">
  âš ï¸ ä¾¡æ ¼ã¯éšæ™‚å¤‰å‹•ã—ã¾ã™ã€‚ãƒªãƒ³ã‚¯å…ˆã§æœ€çµ‚ä¾¡æ ¼ã‚’å¿…ãšã”ç¢ºèªãã ã•ã„ã€‚
</div>

<div class="products" id="productList">
  <div class="loading-wrap">
    <div class="loading-spinner"></div>
    <div class="loading-text">ä¾¡æ ¼æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã¾ã™...</div>
  </div>
</div>

<div class="bottom-info">
  ä¾¡æ ¼æƒ…å ±ã¯ææºã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰å–å¾—ã—ã¦ã„ã¾ã™ã€‚æœ€çµ‚ä¾¡æ ¼ã¯ãƒªãƒ³ã‚¯å…ˆã§ã”ç¢ºèªãã ã•ã„ã€‚<br>
  å½“ã‚µã‚¤ãƒˆã¯Amazonã‚¢ã‚½ã‚·ã‚¨ã‚¤ãƒˆãƒ»æ¥½å¤©ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒ»ã‚µã‚¦ãƒ³ãƒ‰ãƒã‚¦ã‚¹ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«å‚åŠ ã—ã¦ã„ã¾ã™ã€‚<br><br>
  <a href="#" style="color:var(--muted)">é‹å–¶è€…æƒ…å ±</a> | <a href="#" style="color:var(--muted)">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
</div>

<!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="product-detail" id="detailPanel">
  <div class="detail-header">
    <button class="back-btn" onclick="closeDetail()">â† æˆ»ã‚‹</button>
    <div class="detail-title" id="detailTitle"></div>
  </div>
  <div class="detail-hero">
    <div class="detail-img">
      <svg viewBox="0 0 40 40" width="60" height="60" fill="none">
        <rect x="4" y="6" width="32" height="4" rx="2" fill="#ff2d55" opacity=".7"/>
        <rect x="4" y="13" width="32" height="3" rx="1.5" fill="#888"/>
        <rect x="4" y="19" width="32" height="3" rx="1.5" fill="#888"/>
        <rect x="4" y="25" width="32" height="3" rx="1.5" fill="#888"/>
        <rect x="4" y="31" width="32" height="3" rx="1.5" fill="#888"/>
      </svg>
    </div>
    <div class="detail-brand" id="detailBrand"></div>
    <div class="detail-name" id="detailName"></div>
    <div class="detail-price-label">ä»Šæ—¥ã®æœ€å®‰å€¤</div>
    <div class="detail-price" id="detailPrice"></div>
    <div class="detail-diff" id="detailDiff"></div>
  </div>
  <div style="padding:12px 16px;">
    <a id="detailCtaTop" href="#" class="cta-btn" style="margin:0;width:100%;height:64px;font-size:17px;">
      ğŸ”¥ æœ€å®‰ã‚·ãƒ§ãƒƒãƒ—ã§ä»Šã™ãè³¼å…¥ã™ã‚‹ â†’
    </a>
  </div>
  <div class="detail-section">
    <div class="detail-section-title">ğŸ“Š ã‚·ãƒ§ãƒƒãƒ—åˆ¥ä¾¡æ ¼æ¯”è¼ƒ</div>
    <div class="shop-list" id="detailShopList"></div>
  </div>
  <div class="detail-section">
    <div class="detail-section-title">ğŸ“ˆ ä¾¡æ ¼çŠ¶æ³</div>
    <div class="ph-grid">
      <div class="ph-item"><div class="ph-item-label">30æ—¥æœ€å®‰å€¤</div><div class="ph-item-price lowest" id="d30low"></div></div>
      <div class="ph-item"><div class="ph-item-label">ç¾åœ¨ä¾¡æ ¼</div><div class="ph-item-price current" id="d30now"></div></div>
      <div class="ph-item"><div class="ph-item-label">30æ—¥å¹³å‡</div><div class="ph-item-price avg" id="d30avg"></div></div>
    </div>
  </div>
  <div class="detail-section">
    <div class="detail-section-title">ğŸ¯ ä»Šã¯è²·ã„ã‹ï¼Ÿ</div>
    <div class="judge-card" id="judgeCard">
      <div class="judge-icon" id="judgeIcon"></div>
      <div class="judge-label" id="judgeLabel"></div>
      <div class="judge-desc" id="judgeDesc"></div>
    </div>
  </div>
  <div style="padding:16px;">
    <a id="detailCtaBottom" href="#" class="cta-btn" style="margin:0;width:100%;height:60px;">
      ğŸ”¥ æœ€å®‰ã‚·ãƒ§ãƒƒãƒ—ã§è³¼å…¥ã™ã‚‹ â†’
    </a>
  </div>
  <div class="bottom-info">
    â€» ä¾¡æ ¼ã¯å¤‰å‹•ã—ã¾ã™ã€‚ãƒªãƒ³ã‚¯å…ˆã§æœ€çµ‚ä¾¡æ ¼ã‚’ã”ç¢ºèªãã ã•ã„ã€‚<br>
    å½“ã‚µã‚¤ãƒˆã¯ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«å‚åŠ ã—ã¦ã„ã¾ã™ã€‚
  </div>
</div>

<script>
// ============================================================
// â–¼â–¼â–¼ ã“ã“ã ã‘æ›¸ãæ›ãˆã¦ãã ã•ã„ â–¼â–¼â–¼
const GAS_URL = 'https://script.google.com/macros/s/AKfycbw9AP4GaFVIsH1zwwiYqT74TSoIZL2tiMQdX3qtcZZVhjgSM8ytitpRPiTsizsIKW41xg/exec';
// â–²â–²â–² GASãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«ç™ºè¡Œã•ã‚Œã‚‹URLã‚’ã“ã“ã«è²¼ã‚‹ â–²â–²â–²
// ============================================================

let allProducts   = [];
let currentFilter = '4str';

/* ---------- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---------- */
const fmtPrice = n => (!n || isNaN(n)) ? 'â€”' : 'Â¥' + Number(n).toLocaleString();

const shopMeta = name => {
  if (name.includes('Amazon')) return { icon:'ğŸ›’', cls:'shop-icon-amazon' };
  if (name.includes('æ¥½å¤©'))   return { icon:'ğŸ¦…', cls:'shop-icon-rakuten' };
  return { icon:'ğŸ¸', cls:'shop-icon-sh' };
};

const STRING_SVG = `<svg viewBox="0 0 40 40" fill="none">
  <rect x="4" y="6" width="32" height="4" rx="2" fill="#ff2d55" opacity=".7"/>
  <rect x="4" y="13" width="32" height="3" rx="1.5" fill="#888"/>
  <rect x="4" y="19" width="32" height="3" rx="1.5" fill="#888"/>
  <rect x="4" y="25" width="32" height="3" rx="1.5" fill="#888"/>
  <rect x="4" y="31" width="32" height="3" rx="1.5" fill="#888"/>
</svg>`;

/* ---------- è²·ã„åˆ¤å®š ---------- */
function calcJudge(now, low30, avg30) {
  if (!low30 || !avg30) return { cls:'judge-avg', icon:'âš–ï¸', label:'â—‹ å‚è€ƒä¾¡æ ¼', desc:'ä¾¡æ ¼å±¥æ­´ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚' };
  const ratio = (now - low30) / ((avg30 - low30) || 1);
  if (ratio <= 0.3) return { cls:'judge-good', icon:'ğŸ”¥', label:'â— ä»ŠãŒç‹™ã„ç›®ï¼',
    desc:`éå»30æ—¥æœ€å®‰å€¤ã«è¿‘ã„æ°´æº–ã§ã™ã€‚å¹³å‡ã‚ˆã‚Š${fmtPrice(avg30-now)}ãŠå¾—ã§ã™ã€‚ä»ŠãŒè²·ã„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã™ã€‚` };
  if (ratio <= 0.7) return { cls:'judge-avg', icon:'âš–ï¸', label:'â—‹ å¹³å‡æ°´æº–',
    desc:`30æ—¥é–“ã®å¹³å‡çš„ãªä¾¡æ ¼å¸¯ã§ã™ã€‚æ€¥ãã§ãªã‘ã‚Œã°ã‚‚ã†å°‘ã—å¾…ã¤æ‰‹ã‚‚ã‚ã‚Šã¾ã™ã€‚` };
  return { cls:'judge-high', icon:'â³', label:'â–³ ã‚„ã‚„é«˜ã‚',
    desc:`éå»30æ—¥æœ€å®‰ã‚ˆã‚Š${fmtPrice(now-low30)}ã»ã©é«˜ã„æ°´æº–ã§ã™ã€‚ã‚‚ã†å°‘ã—å¾…ã¤ã®ãŒãŠã™ã™ã‚ã§ã™ã€‚` };
}

function meterPct(now, low30, avg30) {
  if (!low30 || !avg30 || avg30 === low30) return 50;
  return Math.min(100, Math.max(5, Math.round((1 - (now-low30)/(avg30-low30)) * 100)));
}
const meterColor = p => p >= 70
  ? 'linear-gradient(90deg,#00e676,#4aff8c)'
  : p >= 40 ? 'linear-gradient(90deg,#ffd700,#ffee88)'
  : 'linear-gradient(90deg,#888,#aaa)';

/* ---------- ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ ---------- */
function buildCard(p, idx) {
  const shops = [
    { name:'Amazon',        price: Number(p.amazon_price),     url: p.amazon_url },
    { name:'æ¥½å¤©å¸‚å ´',      price: Number(p.rakuten_price),    url: p.rakuten_url },
    { name:'ã‚µã‚¦ãƒ³ãƒ‰ãƒã‚¦ã‚¹',price: Number(p.soundhouse_price), url: p.soundhouse_url },
  ].filter(s => s.price > 0).sort((a,b) => a.price - b.price);

  const cheapest = shops[0]?.price || 0;
  const low30    = Number(p.low30)  || 0;
  const avg30    = Number(p.avg30)  || cheapest;
  const pct      = meterPct(cheapest, low30, avg30);
  const judge    = calcJudge(cheapest, low30, avg30);
  const diffAmt  = Math.round(avg30 - cheapest);
  const statusCls= judge.cls === 'judge-good' ? 'status-good' : judge.cls === 'judge-high' ? 'status-high' : 'status-avg';

  const shopBtns = shops.slice(0,3).map((s,i) => `
    <div class="shop-btn${i===0?' best-shop':''}">
      <div class="shop-name">${shopMeta(s.name).icon} ${s.name.replace('ã‚µã‚¦ãƒ³ãƒ‰ãƒã‚¦ã‚¹','SH')}</div>
      <div class="shop-price ${i===0?'cheapest':'normal'}">${fmtPrice(s.price)}</div>
    </div>`).join('');

  const tagHtml = (p.tags||'').split(',').map(t=>t.trim()).filter(Boolean).map(t => {
    const cls = t==='ã‚³ãƒ¼ãƒ†ã‚£ãƒ³ã‚°'?'tag-coated':t==='ãƒ‹ãƒƒã‚±ãƒ«'?'tag-nickel':t==='5å¼¦'?'tag-5str':'';
    return `<span class="tag ${cls}">${t}</span>`;
  }).join('');

  return `<div class="product-card" data-tags="${p.string_type}" data-id="${p.id}"
      style="animation-delay:${idx*.08}s" onclick="openDetail('${p.id}')">
    <div class="card-body">
      <div class="product-img">${STRING_SVG}</div>
      <div class="product-info">
        <div class="product-brand">${p.brand}</div>
        <div class="product-name">${p.model}</div>
        <div class="product-tags">${tagHtml}</div>
        <div class="price-block">
          <div>
            <div class="price-label">ä»Šæ—¥ã®æœ€å®‰</div>
            <div class="price-main">${fmtPrice(cheapest)}</div>
          </div>
          ${diffAmt > 0 ? `<div class="price-diff">â–¼${diffAmt.toLocaleString()}å††ãŠå¾—</div>` : ''}
        </div>
      </div>
    </div>
    <div class="buy-meter">
      <div class="meter-label">
        <span>30æ—¥æœ€å®‰å€¤ãƒ¬ãƒ™ãƒ«</span>
        <span>éå»æœ€å®‰ï¼š${fmtPrice(low30)}</span>
      </div>
      <div class="meter-track">
        <div class="meter-fill" style="width:${pct}%;background:${meterColor(pct)};"></div>
      </div>
      <div class="meter-status ${statusCls}">${judge.icon} ${judge.label}</div>
    </div>
    <div class="shop-compare">${shopBtns}</div>
    <a href="${shops[0]?.url||'#'}" class="cta-btn" onclick="event.stopPropagation()">
      <span>ğŸ”¥ æœ€å®‰ã‚·ãƒ§ãƒƒãƒ—ã§è³¼å…¥ã™ã‚‹</span>
      <span style="font-size:18px">â†’</span>
    </a>
  </div>`;
}

/* ---------- ä¸€è¦§æç”» ---------- */
function renderList(filter) {
  const list     = document.getElementById('productList');
  const filtered = allProducts.filter(p => (p.string_type||'').includes(filter));
  if (!filtered.length) {
    list.innerHTML = `<div class="error-wrap"><div class="error-icon">ğŸ“­</div>
      <div class="error-text">ã“ã®æ¡ä»¶ã®å•†å“ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</div></div>`;
    return;
  }
  list.innerHTML = filtered.map((p,i) => buildCard(p,i)).join('');
}

/* ---------- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ ---------- */
function filterProducts(tag, el) {
  currentFilter = tag;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderList(tag);
}

/* ---------- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« ---------- */
function openDetail(id) {
  const p = allProducts.find(x => x.id === id);
  if (!p) return;

  const shops = [
    { name:'Amazon',        price:Number(p.amazon_price),     url:p.amazon_url },
    { name:'æ¥½å¤©å¸‚å ´',      price:Number(p.rakuten_price),    url:p.rakuten_url },
    { name:'ã‚µã‚¦ãƒ³ãƒ‰ãƒã‚¦ã‚¹',price:Number(p.soundhouse_price), url:p.soundhouse_url },
  ].filter(s=>s.price>0).sort((a,b)=>a.price-b.price);

  const cheapest = shops[0]?.price || 0;
  const low30    = Number(p.low30) || 0;
  const avg30    = Number(p.avg30) || cheapest;
  const judge    = calcJudge(cheapest, low30, avg30);
  const diffAmt  = Math.round(avg30 - cheapest);

  document.getElementById('detailTitle').textContent  = p.model;
  document.getElementById('detailBrand').textContent  = p.brand.toUpperCase();
  document.getElementById('detailName').textContent   = p.model;
  document.getElementById('detailPrice').textContent  = fmtPrice(cheapest);
  document.getElementById('detailDiff').textContent   = diffAmt > 0
    ? `â–¼ 30æ—¥å¹³å‡ã‚ˆã‚Š${diffAmt.toLocaleString()}å††ãŠå¾—` : '30æ—¥å¹³å‡æ°´æº–';
  document.getElementById('d30low').textContent = fmtPrice(low30);
  document.getElementById('d30now').textContent = fmtPrice(cheapest);
  document.getElementById('d30avg').textContent = fmtPrice(avg30);

  const jc = document.getElementById('judgeCard');
  jc.className = 'judge-card ' + judge.cls;
  document.getElementById('judgeIcon').textContent  = judge.icon;
  document.getElementById('judgeLabel').textContent = judge.label;
  document.getElementById('judgeDesc').textContent  = judge.desc;

  document.getElementById('detailShopList').innerHTML = shops.map((s,i) => {
    const meta = shopMeta(s.name);
    return `<a href="${s.url||'#'}" class="shop-row ${i===0?'cheapest-row':''}">
      <div class="shop-row-left">
        <div class="shop-icon ${meta.cls}">${meta.icon}</div>
        <div>
          <div class="shop-row-name">${s.name}</div>
          <div class="shop-row-note">${i===0?'âœ… ä»Šæ—¥ã®æœ€å®‰':'é€šå¸¸ä¾¡æ ¼'}</div>
        </div>
      </div>
      <div class="shop-row-price ${i===0?'cheapest':''}">${fmtPrice(s.price)}</div>
    </a>`;
  }).join('');

  const url = shops[0]?.url || '#';
  document.getElementById('detailCtaTop').href    = url;
  document.getElementById('detailCtaBottom').href = url;
  document.getElementById('detailPanel').style.display = 'block';
  document.body.style.overflow = 'hidden';
}

function closeDetail() {
  document.getElementById('detailPanel').style.display = 'none';
  document.body.style.overflow = '';
}

/* ---------- èµ·å‹•ï¼šGASã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾— ---------- */
(async () => {
  const badge     = document.getElementById('updateBadge');
  const updatedAt = document.getElementById('updatedAt');

  let data = null;
  try {
    const res = await fetch(GAS_URL);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    data = await res.json();
  } catch(e) {
    console.error(e);
  }

  if (!data?.products?.length) {
    document.getElementById('productList').innerHTML = `
      <div class="error-wrap">
        <div class="error-icon">âš ï¸</div>
        <div class="error-text">
          ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚<br>
          <strong>GAS_URL</strong> ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚<br><br>
          è¨­å®šæ‰‹é †ã¯åŒæ¢±ã® <strong>readme.txt</strong> ã‚’ã”è¦§ãã ã•ã„ã€‚
        </div>
      </div>`;
    badge.textContent = 'âš ï¸ å–å¾—ã‚¨ãƒ©ãƒ¼';
    return;
  }

  allProducts = data.products;
  const ts = data.updated_at
    ? new Date(data.updated_at).toLocaleDateString('ja-JP',{month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'})
    : 'æ›´æ–°æ¸ˆ';
  badge.textContent   = 'ğŸ”´ LIVEæ›´æ–°ä¸­';
  updatedAt.textContent = ts + ' æ›´æ–°';
  renderList(currentFilter);
})();
</script>
</body>
</html>
